---
title: "HW3"
author: "Zhenkun Fang"
date: "2024-10-16"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(tidyverse)
library(ggridges)
library(patchwork)
library(readr)
library(dplyr)
library(p8105.datasets)
data("ny_noaa")

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
```

# Problem 1
This dataset consists of `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns. The variables include the weather station ID, observation date, precipitation (measured in tenths of millimeters), snowfall (in millimeters), snow depth (in millimeters), and both minimum and maximum temperatures (in tenths of degrees Celsius).

```{r}
ny_noaa %>% 
  count(tmax) %>%
  arrange(desc(n))

ny_noaa %>% 
  count(tmin) %>%
  arrange(desc(n))
```

For vairbles `tmax` and `tmin`, nearly half of the observations are `NA`, indicating that there is a serious issue of missing data.

```{r}
ny_noaa %>% 
  count(snow) %>%
  arrange(desc(n))

ny_noaa = 
  ny_noaa %>% 
  separate(date, into = c("year", "month", "day"), convert = TRUE) %>% 
  mutate(
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin))
```

For the variable `snow`, the most frequently observed value is 0, reflecting that snowfall does not occur on most days in NY. The second most common value is `NA`, indicating missing data.

```{r two-panel plot}
ny_noaa %>% 
  group_by(id, year, month) %>% 
  filter(month %in% c(1, 7)) %>% 
  summarize(mean_tmax = mean(tmax, na.rm = TRUE, color = id)) %>% 
  ggplot(aes(x = year, y = mean_tmax, group = id)) + geom_point() + geom_path() +
  facet_grid(~month) +
  labs(title = "Mean monthly temperature for each station across years for January and July",
       x = "Year",
       y = "Average max temperature")
```

The two-panel plot below displays the average maximum temperature in January and July across stations over the years. As expected, the mean temperature in January is significantly lower than in July for all stations and years. The stations generally follow similar temperature patterns, with peaks and valleys within each month across the years—when one station has a high monthly mean temperature for a given year, most other stations exhibit a similar trend. However, there is one notably cold station in July of 1987 or 1988, along with a few other less extreme outliers.

```{r another two-panel plot}
hex = 
  ny_noaa %>% 
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_hex()

ridge = 
  ny_noaa %>% 
  filter(snow < 100, snow > 0) %>% 
  ggplot(aes(x = tmax, y = as.factor(year))) + 
  geom_density_ridges(scale = .90)
  
hex+ridge
```

# Problem 2
```{r load datasets}
demodata = 
  read_csv("/Users/rubp/Desktop/Data Sci 1/Week7/p8105_hw3_zf2352/nhanes_covar.csv",
            na = c("NA", ".", "")) %>% 
  janitor::clean_names() 

accel = 
  read_csv("/Users/rubp/Desktop/Data Sci 1/Week7/p8105_hw3_zf2352/nhanes_accel.csv",
            na = c("NA", ".", "")) %>% 
  janitor::clean_names()
```

```{r tidy, merge, and organize datasets}
demodata = 
  demodata[-c(1 ,2 ,3 , 4), ]

colnames(demodata) [1] = "seqn"
colnames(demodata) [2] = "sex"
colnames(demodata) [3] = "age"
colnames(demodata) [4] = "bmi"
colnames(demodata) [5] = "education"

demodata = demodata %>% 
  mutate(seqn = as.numeric(seqn))

accel = accel %>% 
  mutate(seqn = as.numeric(seqn))

mims = demodata %>% 
  left_join(accel, by = "seqn") %>% 
  drop_na(bmi, education) %>% 
  filter(age >= 21) %>% 
  mutate(
    sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female")),
    education = factor(education, levels = c(1, 2, 3), 
                       labels = c("Less than high school",
                              "High school equivalent",
                              "More than high school")),
    age = as.numeric(age),
    bmi = as.numeric(bmi)
  )
```

```{r produce table}
mims_table = mims %>% 
  count(sex, education) %>% 
  spread(sex, n) %>% 
  knitr::kable()

mims_table
```

```{r create visualization}
mims_ridge = mims %>% 
  ggplot(aes(x = age, y = as.factor(education))) + 
  facet_grid(~sex) +
  geom_density_ridges(scale = .90) +
  labs(
    title = "Age distributions for men and women in each education category",
    x = "Age (years)",
    y = "Education"
  )

mims_ridge
```

The distribution across education levels shows that there is a fairly balanced gender representation in the "Less than high school" and "More than high school" categories. However, for the "High school equivalent" category, there is a notable gender disparity, with more males than females.

The gender distribution within each education category is relatively balanced, though there are slight variations, particularly in the "High school equivalent" category where males outnumber females around the age of 30. For both sexes, participants with "Less than high school" education tend to be older, particularly concentrated in the 60-80 age range, which might suggest that older individuals in this dataset tend to have less formal education.

```{r total activity variable}
mims_total = mims %>% 
  rowwise() %>% 
  mutate(total_activity = sum(c_across(starts_with("min")), na.rm = TRUE)) %>% 
  relocate(last_col(), .before = 6)
```

```{r visualization}
mims_total %>% 
  ggplot(aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = .5) +
  geom_smooth(se = FALSE) + 
  facet_grid(. ~ education) +
  labs(
    x = "Age (years)",
    y = "Total accelerometer activity",
    title = "Total accelerometer activity of men and women with different education"
  )
```

Across all education categories, there is a noticeable decrease in total accelerometer activity as age increases, particularly after age 60. This trend is consistent with expectations that physical activity generally decreases as people age.

- Less than high school: Men tend to have a slight edge in activity levels compared to women, particularly in younger age groups, though both genders show a steep decline in activity after age 60. The smooth trend for women appears to dip more significantly at older ages.

- High school equivalent: In this group, women's activity levels seem to peak around middle age (40–50 years) and remain higher than men's for a significant portion of the age range. However, the activity levels for both men and women drop sharply after age 60.

- More than high school: In the more educated group, men and women have more comparable activity levels, with some fluctuations around age 40–60. Women's activity seems to remain relatively higher at older ages in this category.

```{r activity of the day}
mims_total_long = mims_total %>% 
  pivot_longer(cols = starts_with("min"), 
               names_to = "minute", 
               values_to = "activity") %>% 
  mutate(minute = as.numeric(gsub("min", "", minute))) %>% 
  group_by(education, sex, minute) %>% 
  summarise(avg_activity = mean(activity, na.rm = TRUE))
```

```{r plot-24 hour}
mims_total_long %>% 
  ggplot(aes(x = minute, y = avg_activity, color = sex)) +
  geom_line(alpha = .5) +  
  geom_smooth(method = "loess", se = FALSE) +
  facet_wrap(~ education) +
  labs(
    x = "Minute in 24 hours",
    y = "Average activity",
    title = "24-hour activity time courses for each education level"
  )
```

Across all education levels, the activity levels follow a similar daily pattern, with a sharp increase in activity after the start of the day (around minute 500, corresponding to roughly 8 AM), peaking around midday, and then gradually declining into the evening.

In general, women appear to have slightly higher activity levels throughout the day compared to men across all education levels, especially during the peak activity hours around midday. The smooth trends for women (in teal) often show a more sustained or higher peak of activity than men (in red), particularly in the "High school equivalent" and "More than high school" groups.

Participants with more education tend to have higher activity levels overall, especially during the peak hours of the day. In the "more than high school" group, the curves for both men and women show a higher midday peak, which could suggest a more active and structured lifestyle. Women in this group show a particularly strong midday peak, indicating higher physical engagement during daytime hours.

# Probelm 3
```{r import and clean data}
jan_2020 = 
  read_csv("/Users/rubp/Desktop/Data Sci 1/Week7/p8105_hw3_zf2352/citibike/Jan 2020 Citi.csv", na = c("NA", ".", "")) %>% 
  janitor::clean_names() 

jan_2024 = 
  read_csv("/Users/rubp/Desktop/Data Sci 1/Week7/p8105_hw3_zf2352/citibike/Jan 2024 Citi.csv",
            na = c("NA", ".", "")) %>% 
  janitor::clean_names()

jul_2020 = 
  read_csv("/Users/rubp/Desktop/Data Sci 1/Week7/p8105_hw3_zf2352/citibike/July 2020 Citi.csv",
            na = c("NA", ".", "")) %>% 
  janitor::clean_names()

jul_2024 = 
  read_csv("/Users/rubp/Desktop/Data Sci 1/Week7/p8105_hw3_zf2352/citibike/July 2024 Citi.csv",
            na = c("NA", ".", "")) %>% 
  janitor::clean_names()
```

```{r}
citi_bike = bind_rows(
  jan_2020 |>
    mutate(month = "January", year = 2020),
  jul_2020 |>
    mutate(month = "July", year = 2020),
  jan_2024 |>
    mutate(month = "January", year = 2024),
  jul_2024 |>
    mutate(month = "July", year = 2024)
) |>
  relocate(year, month) |>
  drop_na(start_station_name, end_station_name, member_casual)
```

The dataset have 9 columns and more than 99253 observations:

- year: year of data collection time.

- month: month of data collection time.

- ride_id: Unique identifier for each ride. 

- rideable_type: Type of bike (e.g., classic bike). 

- weekdays: Day of the week the ride occurred. 

- duration: Duration of the ride in minutes. 

- start_station_name: Station where the ride started. 

- end_station_name: Station where the ride ended. 

- member_casual: Type of user (member or casual).

```{r create table}
citi_bike %>% 
  group_by(year, month, member_casual) %>% 
  summarize(total_rides = n()) %>% 
  spread(member_casual, total_rides, fill = 0) %>% 
  knitr::kable()
```

Both casual and member ridership increased from 2020 to 2024, suggesting a growth in the Citi Bike system's overall usage.

The seasonal variation is clear, with July showing higher ridership compared to January in both years, likely due to weather conditions.

```{r table-5 most popular stations}
jul_2024 %>% 
  group_by(start_station_name) %>%
  summarise(ride_count = n()) %>%
  arrange(desc(ride_count)) %>%
  head(5) %>% 
  knitr::kable()
```

```{r}
median_duration_data = citi_bike %>%
  group_by(weekdays, month, year) %>%
  summarise(median_duration = median(duration, na.rm = TRUE))

median_duration_data$weekdays <- factor(median_duration_data$weekdays, 
                                        levels = c("Monday", "Tuesday", 
                                                   "Wednesday", "Thursday", 
                                                   "Friday", "Saturday",
                                                   "Sunday"))
```

```{r plot}
median_duration_data %>% 
  ggplot(aes(x = weekdays, y = median_duration, fill = month)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ year, scales = "free") +  
  labs(title = "Median Ride Duration by Weekdays, Month, and Year",
       x = "Day of the Week",
       y = "Median Ride Duration (minutes)",
       fill = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Across both 2020 and 2024, the median ride duration in July is consistently higher than in January for all days of the week. This is likely due to the more favorable weather conditions in July, which encourages longer rides.

In both years, the median ride duration appears to be higher on weekends (Saturday and Sunday) compared to weekdays, suggesting that people may engage in longer rides for recreational purposes on weekends.

In 2024, the overall median ride durations for both January and July are slightly lower compared to 2020. This could indicate that rides have become shorter on average, possibly due to changes in user behavior, bike availability, or other external factors.

```{r}
data_2024 = citi_bike %>% 
  filter(year == 2024)

ggplot(data_2024, aes(x = member_casual, y = duration, fill = rideable_type)) +
  geom_violin(scale = "width", adjust = 1.5, trim = FALSE) +
  facet_wrap(~ month) +
  labs(title = "Impact of Month, Membership Status, and Bike Type on Ride Duration (2024)",
       x = "Membership Status",
       y = "Ride Duration (minutes)",
       fill = "Bike Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Electric bikes (in blue) generally show shorter ride durations compared to classic bikes (in red) across all groups, particularly among members. This suggests that electric bikes are predominantly used for shorter trips, likely due to their higher speed and convenience for quick commutes.

Casual riders using classic bikes have a wider range of ride durations compared to members, with some rides extending up to or beyond 200 minutes. This could indicate that casual riders use the bikes more for leisure or tourism-related activities, whereas members typically take shorter, more consistent trips, possibly for commuting or other routine purposes.

In July, ride durations are slightly more variable than in January, particularly for casual riders. The warmer weather in July might encourage longer, more leisurely rides, especially for casual users.

Members consistently take shorter trips with less variation in ride duration, regardless of the bike type or month.
